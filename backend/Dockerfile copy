FROM node:18
WORKDIR /config/workspace/vm/js/TCon360
RUN npm install -g pnpm@10.12.1 --force
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY backend/package.json backend/pnpm-lock.yaml ./backend/
COPY backend/prisma ./backend/prisma
COPY packages/config ./packages/config
RUN ls -la /config/workspace/vm/js/TCon360 && cat /config/workspace/vm/js/TCon360/package.json
RUN if ! grep -q '"build":' /config/workspace/vm/js/TCon360/backend/package.json; then \
      echo 'Error: "build" script not found in backend/package.json'; \
      exit 1; \
    fi
# Install dependencies for the entire workspace
RUN pnpm install
# Build @tcon360/config
RUN cd packages/config && pnpm build
# Generate Prisma client
RUN cd backend && npx prisma generate
# Copy backend source and build
COPY backend/ ./backend/
RUN cd backend && pnpm run build
# Set environment variables
ENV JWT_SECRET=aBcDeFgHiJkLmNoPqRsTuVwXyZ0123456789
ENV DATABASE_URL=file:./TCon360.db
ENV BACKEND_PORT=3800
ENV TOKEN_MAX_AGE=113000
ENV PROXY_PATH=/absproxy
ENV FRONTEND_PORT=3000
ENV USE_REVERSE_PROXY=false
ENV NODE_ENV=production
EXPOSE 3800
CMD ["pnpm", "--filter", "backend", "run", "start:prod"]